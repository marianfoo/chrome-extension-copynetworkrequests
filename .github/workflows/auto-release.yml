name: Auto Release (feat/fix)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  auto-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version, update changelog, tag
        run: |
          python3 - <<'PY'
          import json
          import os
          import re
          import subprocess
          from datetime import datetime
          from pathlib import Path
          
          def sh(cmd):
            return subprocess.check_output(cmd, shell=True, text=True).strip()
          
          # Determine range since last tag
          tags = sh("git tag --sort=-v:refname").splitlines()
          last_tag = tags[0] if tags and tags[0] else ""
          if last_tag:
            log_range = f"{last_tag}..HEAD"
          else:
            root = sh("git rev-list --max-parents=0 HEAD")
            log_range = f"{root}..HEAD"
          
          commits = sh(f"git log {log_range} --pretty=format:%s").splitlines()
          if not commits:
            print("No commits found for release.")
            raise SystemExit(0)
          
          feats = [c for c in commits if c.startswith("feat")]
          fixes = [c for c in commits if c.startswith("fix")]
          
          if not feats and not fixes:
            print("No feat/fix commits found. Skipping release.")
            raise SystemExit(0)
          
          bump = "minor" if feats else "patch"
          
          manifest_path = Path("network-request-response-copier/manifest.json")
          manifest = json.loads(manifest_path.read_text())
          version = manifest.get("version", "0.0.0")
          
          m = re.match(r"^(\d+)\.(\d+)\.(\d+)$", version)
          if not m:
            raise SystemExit(f"Invalid manifest version: {version}")
          
          major, minor, patch = map(int, m.groups())
          if bump == "minor":
            minor += 1
            patch = 0
          else:
            patch += 1
          
          new_version = f"{major}.{minor}.{patch}"
          manifest["version"] = new_version
          manifest_path.write_text(json.dumps(manifest, indent=2) + "\n")
          
          # Update CHANGELOG.md
          changelog_path = Path("CHANGELOG.md")
          if not changelog_path.exists():
            changelog_path.write_text("# Changelog\n\n## [Unreleased]\n")
          
          changelog = changelog_path.read_text()
          date = datetime.utcnow().strftime("%Y-%m-%d")
          
          def format_section(title, items):
            if not items:
              return ""
            lines = [f"### {title}"]
            for item in items:
              lines.append(f"- {item}")
            return "\n".join(lines) + "\n"
          
          entry = [f"## [{new_version}] - {date}"]
          entry.append(format_section("Added", feats).rstrip())
          entry.append(format_section("Fixed", fixes).rstrip())
          entry = "\n".join([e for e in entry if e]).strip() + "\n"
          
          if "## [Unreleased]" in changelog:
            parts = changelog.split("## [Unreleased]", 1)
            updated = parts[0] + "## [Unreleased]\n\n" + entry + parts[1].lstrip()
          else:
            updated = "## [Unreleased]\n\n" + entry + "\n" + changelog
          
          changelog_path.write_text(updated)
          
          # Commit and tag
          sh("git add network-request-response-copier/manifest.json CHANGELOG.md")
          sh(f"git commit -m \"chore: release version {new_version}\"")
          sh(f"git tag v{new_version}")
          
          print(f\"Released v{new_version}\")
          PY

      - name: Push commit and tag
        run: |
          git push origin main
          git push origin --tags
